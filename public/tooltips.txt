// line chart
function tooltipFunction(data) {
  const tooltipRectangles = document.querySelectorAll('.tooltip-listening-rectangle');

  const closingPriceNumberFormatterObject = new Intl.NumberFormat('en-US', {style: 'currency', currency: 'USD', minimumFractionDigits: 4, maximumFractionDigits:4});
  const thousandsSeparandNumberFormatterObject = new Intl.NumberFormat('en-GB');

  const dateFormatter = date => { return timeFormat("%d-%b-%Y")( (new Date().getTimezoneOffset() < 0) ? date : utcDay.offset(date, 1) )};

  let n = 0;
  tooltipRectangles.forEach( (rectangle) => {
    const price = data[n].closingPriceData;
    const volume = data[n].tradingVolumeData;

    const tooltip = document.querySelectorAll('.tooltip')[n];
    const tooltipDot = document.querySelectorAll('svg#linechart circle')[n];
    const tooltipLineX = document.querySelectorAll('.tooltip-line-x')[n];

    const xAccessor = d => isoParse(d[0]);
    const yAccessor = d => +d[1];

    const xScale = scaleTime()
      .domain( extent(price, xAccessor) )
      .range([0, 400 - 80]);

    const yScale = scaleLinear()
      .domain( [0, max(price, yAccessor)] )
      .range([80 - 55 + 15, 0])
      .nice();

    rectangle.addEventListener('pointermove', (e) => {
      const userScreenWidth = () => {
        const screenWidth = window.innerWidth;
        if (screenWidth > 1599) return (xPos ) + 'px'
        if (screenWidth > 1499) return (xPos ) + 'px'
        if (screenWidth > 1399) return (xPos ) + 'px'
        if (screenWidth > 1299) return (xPos / 2) + 'px'
        if (screenWidth > 1099) return (xPos / 2) + 'px'
        if (screenWidth > 999) return (xPos / 4) + 'px'
        if (screenWidth > 890) return (xPos/ 4) + 'px'
        if (screenWidth > 800) return (xPos / 4) + 'px'
        if (screenWidth > 680) return (xPos  / 4) + 'px'
        if (screenWidth > 599) return (xPos  / 4) + 'px'
        if (screenWidth > 524) return (xPos / 4) + 'px'
        if (screenWidth > 479) return (xPos / 4) + 'px'
        if (screenWidth > 419) return (xPos - 30) + 'px'
        return (xPos / 1.75 ) + 'px'
      };

      const [xCord] = pointer(e);
      const bisectDate = bisector(xAccessor).center;
      const x0 = xScale.invert(xCord);

      const i = bisectDate(price, x0);
      const d = price[i];
      const xPos = xScale(xAccessor(d));
      const yPos = yScale(yAccessor(d));

      const h = bisectDate(volume, x0);
      const vol = volume[h][1];

      tooltipDot.style.opacity = 1;
      tooltipDot.setAttribute('cx', (xPos) + 'px');
      tooltipDot.setAttribute('cy', (yPos) + 'px');

      tooltip.style.display = 'block';
      tooltip.style.left = userScreenWidth();
      tooltip.style.top = '-40' + 'px';
      tooltip.querySelector('.price').textContent = `${closingPriceNumberFormatterObject.format(yAccessor(d))}`;
      tooltip.querySelector('.date').textContent = dateFormatter(xAccessor(d));
      tooltip.querySelector('.volume').textContent = `${thousandsSeparandNumberFormatterObject.format(vol)}`;

      tooltipLineX.style.display = 'block';
      tooltipLineX.setAttribute('x1', (xPos) + 'px');
      tooltipLineX.setAttribute('x2', (xPos) + 'px');
      tooltipLineX.setAttribute('y1', -5);
      tooltipLineX.setAttribute('y2', 80 -52 +15);
    });

    rectangle.addEventListener('pointerleave', (e) => {
      tooltipDot.style.opacity = 0;
      tooltip.style.display = 'none';
      tooltipLineX.style.display = 'none';
    });

    rectangle.addEventListener('pointercancel', (e) => {
      tooltipDot.style.opacity = 0;
      tooltip.style.display = 'none';
      tooltipLineX.style.display = 'none';
    });

    rectangle.addEventListener('touchstart', (e) => {
      e.preventDefault();
    });
    n++;
  })
}
// pie chart
function pieChart(data) {
  const numberFormatterObject = new Intl.NumberFormat('en-US', {style: 'currency', currency: 'USD', maximumFractionDigits:0});

  const arcs = Array.from( document.querySelectorAll('#pie-chart path') );
  const tooltip = document.querySelector('.tooltip__pie-chart');

  let m = 0;
  arcs.forEach( arc => {
    const equity = data[m].name;
    const value = data[m].marketCap;
    
    arc.addEventListener('pointermove', (e) => {
      const pieChartContainerYposition = document.querySelector('svg#pie-chart').getBoundingClientRect().top;
      const pointerPosition = e.clientY;
      const tooltipYaxisPosition = pointerPosition - pieChartContainerYposition;

      tooltip.style.display = 'block';
      tooltip.style.top = ( tooltipYaxisPosition - 37.5 ) + 'px';
      tooltip.style.left = ( e.clientX + 7.5 )  + 'px';
      tooltip.querySelector('.equity').textContent = equity;
      tooltip.querySelector('.value').textContent = numberFormatterObject.format(value);
    });

    arc.addEventListener('pointerleave', () => {
      tooltip.style.display = 'none';
    });

    arc.addEventListener('touchstart', (e) => {
      e.preventDefault();
    });

    m++;
  })
}
//  treemap
function treemap(data) {
  // sort data by market cap
  data.sort( (a,b) => a.market_cap - b.market_cap ).reverse()
  const currencyOneDecimalPointsNumberFormatterObject = new Intl.NumberFormat('en-US', {style: 'currency', currency: 'USD', notation: "compact", compactDisplay: "short", maximumFractionDigits: 1});
  const thousandsSeparandNumberFormatterObject = new Intl.NumberFormat('en-GB');

  const leaves = Array.from(document.querySelectorAll('.treemap-leaves g')).slice(0,13);
  const tooltip =document.querySelector('.tooltip__treemap');

  leaves.forEach( (d,i) => {
    const name = data[i].short_name;
    const ticker = data[i].ticker;
    const marketCap = data[i].market_cap;
    const peRatio = data[i].pe_ratio;
    const tradeVolume30days = data[i].volume_30_day_avg;

    d.addEventListener('pointermove', (e) => {
      e.preventDefault();
      const pieChartContainerYposition = document.querySelector('svg#treemap').getBoundingClientRect().top;
      const pointerPosition = e.clientY;
      const tooltipYaxisPosition = pointerPosition - pieChartContainerYposition;

      tooltip.style.display = 'block';
      tooltip.style.top = ( tooltipYaxisPosition - 82.5 ) + 'px';
      tooltip.style.left = ( e.clientX + 7.5 )  + 'px';
      tooltip.querySelector('.name').textContent = `${name}  (${ticker})`;
      tooltip.querySelector('.market-cap').textContent = 'market cap: ' + currencyOneDecimalPointsNumberFormatterObject.format(marketCap);
      tooltip.querySelector('.pe-ratio').textContent = 'p/e-ratio: ' +  ( !peRatio ? '---' : `${peRatio}x` );
      tooltip.querySelector('.trade-volume-30-days').textContent = '30 day avg volume: ' + thousandsSeparandNumberFormatterObject.format(tradeVolume30days);
    })

    d.addEventListener('pointerleave', () => {
      tooltip.style.display = 'none';
    });

    d.addEventListener('touchstart', (e) => {
      e.preventDefault();
    });    
  })
}
// line chart
function tooltipFunction(data) {
  const tooltipRectangles = document.querySelectorAll('.tooltip-listening-rectangle');

  const closingPriceNumberFormatterObject = new Intl.NumberFormat('en-US', {style: 'currency', currency: 'USD', minimumFractionDigits: 4, maximumFractionDigits:4});
  const thousandsSeparandNumberFormatterObject = new Intl.NumberFormat('en-GB');

  const dateFormatter = date => { return timeFormat("%d-%b-%Y")( (new Date().getTimezoneOffset() < 0) ? date : utcDay.offset(date, 1) )};

  let n = 0;
  tooltipRectangles.forEach( (rectangle) => {
    const price = data[n].closingPriceData;
    const volume = data[n].tradingVolumeData;

    const tooltip = document.querySelectorAll('.tooltip')[n];
    const tooltipDot = document.querySelectorAll('svg#linechart circle')[n];
    const tooltipLineX = document.querySelectorAll('.tooltip-line-x')[n];

    const xAccessor = d => isoParse(d[0]);
    const yAccessor = d => +d[1];

    const xScale = scaleTime()
      .domain( extent(price, xAccessor) )
      .range([0, 400 - 80]);

    const yScale = scaleLinear()
      .domain( [0, max(price, yAccessor)] )
      .range([80 - 55 + 15, 0])
      .nice();

    rectangle.addEventListener('pointermove', (e) => {
      const userScreenWidth = () => {
        const screenWidth = window.innerWidth;
        if (screenWidth > 1599) return (xPos ) + 'px'
        if (screenWidth > 1499) return (xPos ) + 'px'
        if (screenWidth > 1399) return (xPos ) + 'px'
        if (screenWidth > 1299) return (xPos / 2) + 'px'
        if (screenWidth > 1099) return (xPos / 2) + 'px'
        if (screenWidth > 999) return (xPos / 4) + 'px'
        if (screenWidth > 890) return (xPos/ 4) + 'px'
        if (screenWidth > 800) return (xPos / 4) + 'px'
        if (screenWidth > 680) return (xPos  / 4) + 'px'
        if (screenWidth > 599) return (xPos  / 4) + 'px'
        if (screenWidth > 524) return (xPos / 4) + 'px'
        if (screenWidth > 479) return (xPos / 4) + 'px'
        if (screenWidth > 419) return (xPos - 30) + 'px'
        return (xPos / 1.75 ) + 'px'
      };

      const [xCord] = pointer(e);
      const bisectDate = bisector(xAccessor).center;
      const x0 = xScale.invert(xCord);

      const i = bisectDate(price, x0);
      const d = price[i];
      const xPos = xScale(xAccessor(d));
      const yPos = yScale(yAccessor(d));

      const h = bisectDate(volume, x0);
      const vol = volume[h][1];

      tooltipDot.style.opacity = 1;
      tooltipDot.setAttribute('cx', (xPos) + 'px');
      tooltipDot.setAttribute('cy', (yPos) + 'px');

      tooltip.style.display = 'block';
      tooltip.style.left = userScreenWidth();
      tooltip.style.top = '-40' + 'px';
      tooltip.querySelector('.price').textContent = `${closingPriceNumberFormatterObject.format(yAccessor(d))}`;
      tooltip.querySelector('.date').textContent = dateFormatter(xAccessor(d));
      tooltip.querySelector('.volume').textContent = `${thousandsSeparandNumberFormatterObject.format(vol)}`;

      tooltipLineX.style.display = 'block';
      tooltipLineX.setAttribute('x1', (xPos) + 'px');
      tooltipLineX.setAttribute('x2', (xPos) + 'px');
      tooltipLineX.setAttribute('y1', -5);
      tooltipLineX.setAttribute('y2', 80 -52 +15);
    });

    rectangle.addEventListener('pointerleave', (e) => {
      tooltipDot.style.opacity = 0;
      tooltip.style.display = 'none';
      tooltipLineX.style.display = 'none';
    });

    rectangle.addEventListener('pointercancel', (e) => {
      tooltipDot.style.opacity = 0;
      tooltip.style.display = 'none';
      tooltipLineX.style.display = 'none';
    });

    rectangle.addEventListener('touchstart', (e) => {
      e.preventDefault();
    });
    n++;
  })
}
// pie chart
function pieChart(data) {
  const numberFormatterObject = new Intl.NumberFormat('en-US', {style: 'currency', currency: 'USD', maximumFractionDigits:0});

  const arcs = Array.from( document.querySelectorAll('#pie-chart path') );
  const tooltip = document.querySelector('.tooltip__pie-chart');

  let m = 0;
  arcs.forEach( arc => {
    const equity = data[m].name;
    const value = data[m].marketCap;
    
    arc.addEventListener('pointermove', (e) => {
      const pieChartContainerYposition = document.querySelector('svg#pie-chart').getBoundingClientRect().top;
      const pointerPosition = e.clientY;
      const tooltipYaxisPosition = pointerPosition - pieChartContainerYposition;

      tooltip.style.display = 'block';
      tooltip.style.top = ( tooltipYaxisPosition - 37.5 ) + 'px';
      tooltip.style.left = ( e.clientX + 7.5 )  + 'px';
      tooltip.querySelector('.equity').textContent = equity;
      tooltip.querySelector('.value').textContent = numberFormatterObject.format(value);
    });

    arc.addEventListener('pointerleave', () => {
      tooltip.style.display = 'none';
    });

    arc.addEventListener('touchstart', (e) => {
      e.preventDefault();
    });

    m++;
  })
}
//  treemap
function treemap(data) {
  // sort data by market cap
  data.sort( (a,b) => a.market_cap - b.market_cap ).reverse()
  const currencyOneDecimalPointsNumberFormatterObject = new Intl.NumberFormat('en-US', {style: 'currency', currency: 'USD', notation: "compact", compactDisplay: "short", maximumFractionDigits: 1});
  const thousandsSeparandNumberFormatterObject = new Intl.NumberFormat('en-GB');

  const leaves = Array.from(document.querySelectorAll('.treemap-leaves g')).slice(0,13);
  const tooltip =document.querySelector('.tooltip__treemap');

  leaves.forEach( (d,i) => {
    const name = data[i].short_name;
    const ticker = data[i].ticker;
    const marketCap = data[i].market_cap;
    const peRatio = data[i].pe_ratio;
    const tradeVolume30days = data[i].volume_30_day_avg;

    d.addEventListener('pointermove', (e) => {
      e.preventDefault();
      const pieChartContainerYposition = document.querySelector('svg#treemap').getBoundingClientRect().top;
      const pointerPosition = e.clientY;
      const tooltipYaxisPosition = pointerPosition - pieChartContainerYposition;

      tooltip.style.display = 'block';
      tooltip.style.top = ( tooltipYaxisPosition - 82.5 ) + 'px';
      tooltip.style.left = ( e.clientX + 7.5 )  + 'px';
      tooltip.querySelector('.name').textContent = `${name}  (${ticker})`;
      tooltip.querySelector('.market-cap').textContent = 'market cap: ' + currencyOneDecimalPointsNumberFormatterObject.format(marketCap);
      tooltip.querySelector('.pe-ratio').textContent = 'p/e-ratio: ' +  ( !peRatio ? '---' : `${peRatio}x` );
      tooltip.querySelector('.trade-volume-30-days').textContent = '30 day avg volume: ' + thousandsSeparandNumberFormatterObject.format(tradeVolume30days);
    })

    d.addEventListener('pointerleave', () => {
      tooltip.style.display = 'none';
    });

    d.addEventListener('touchstart', (e) => {
      e.preventDefault();
    });    
  })
}
// line chart
function tooltipFunction(data) {
  const tooltipRectangles = document.querySelectorAll('.tooltip-listening-rectangle');

  const closingPriceNumberFormatterObject = new Intl.NumberFormat('en-US', {style: 'currency', currency: 'USD', minimumFractionDigits: 4, maximumFractionDigits:4});
  const thousandsSeparandNumberFormatterObject = new Intl.NumberFormat('en-GB');

  const dateFormatter = date => { return timeFormat("%d-%b-%Y")( (new Date().getTimezoneOffset() < 0) ? date : utcDay.offset(date, 1) )};

  let n = 0;
  tooltipRectangles.forEach( (rectangle) => {
    const price = data[n].closingPriceData;
    const volume = data[n].tradingVolumeData;

    const tooltip = document.querySelectorAll('.tooltip')[n];
    const tooltipDot = document.querySelectorAll('svg#linechart circle')[n];
    const tooltipLineX = document.querySelectorAll('.tooltip-line-x')[n];

    const xAccessor = d => isoParse(d[0]);
    const yAccessor = d => +d[1];

    const xScale = scaleTime()
      .domain( extent(price, xAccessor) )
      .range([0, 400 - 80]);

    const yScale = scaleLinear()
      .domain( [0, max(price, yAccessor)] )
      .range([80 - 55 + 15, 0])
      .nice();

    rectangle.addEventListener('pointermove', (e) => {
      const userScreenWidth = () => {
        const screenWidth = window.innerWidth;
        if (screenWidth > 1599) return (xPos ) + 'px'
        if (screenWidth > 1499) return (xPos ) + 'px'
        if (screenWidth > 1399) return (xPos ) + 'px'
        if (screenWidth > 1299) return (xPos / 2) + 'px'
        if (screenWidth > 1099) return (xPos / 2) + 'px'
        if (screenWidth > 999) return (xPos / 4) + 'px'
        if (screenWidth > 890) return (xPos/ 4) + 'px'
        if (screenWidth > 800) return (xPos / 4) + 'px'
        if (screenWidth > 680) return (xPos  / 4) + 'px'
        if (screenWidth > 599) return (xPos  / 4) + 'px'
        if (screenWidth > 524) return (xPos / 4) + 'px'
        if (screenWidth > 479) return (xPos / 4) + 'px'
        if (screenWidth > 419) return (xPos - 30) + 'px'
        return (xPos / 1.75 ) + 'px'
      };

      const [xCord] = pointer(e);
      const bisectDate = bisector(xAccessor).center;
      const x0 = xScale.invert(xCord);

      const i = bisectDate(price, x0);
      const d = price[i];
      const xPos = xScale(xAccessor(d));
      const yPos = yScale(yAccessor(d));

      const h = bisectDate(volume, x0);
      const vol = volume[h][1];

      tooltipDot.style.opacity = 1;
      tooltipDot.setAttribute('cx', (xPos) + 'px');
      tooltipDot.setAttribute('cy', (yPos) + 'px');

      tooltip.style.display = 'block';
      tooltip.style.left = userScreenWidth();
      tooltip.style.top = '-40' + 'px';
      tooltip.querySelector('.price').textContent = `${closingPriceNumberFormatterObject.format(yAccessor(d))}`;
      tooltip.querySelector('.date').textContent = dateFormatter(xAccessor(d));
      tooltip.querySelector('.volume').textContent = `${thousandsSeparandNumberFormatterObject.format(vol)}`;

      tooltipLineX.style.display = 'block';
      tooltipLineX.setAttribute('x1', (xPos) + 'px');
      tooltipLineX.setAttribute('x2', (xPos) + 'px');
      tooltipLineX.setAttribute('y1', -5);
      tooltipLineX.setAttribute('y2', 80 -52 +15);
    });

    rectangle.addEventListener('pointerleave', (e) => {
      tooltipDot.style.opacity = 0;
      tooltip.style.display = 'none';
      tooltipLineX.style.display = 'none';
    });

    rectangle.addEventListener('pointercancel', (e) => {
      tooltipDot.style.opacity = 0;
      tooltip.style.display = 'none';
      tooltipLineX.style.display = 'none';
    });

    rectangle.addEventListener('touchstart', (e) => {
      e.preventDefault();
    });
    n++;
  })
}
// pie chart
function pieChart(data) {
  const numberFormatterObject = new Intl.NumberFormat('en-US', {style: 'currency', currency: 'USD', maximumFractionDigits:0});

  const arcs = Array.from( document.querySelectorAll('#pie-chart path') );
  const tooltip = document.querySelector('.tooltip__pie-chart');

  let m = 0;
  arcs.forEach( arc => {
    const equity = data[m].name;
    const value = data[m].marketCap;
    
    arc.addEventListener('pointermove', (e) => {
      const pieChartContainerYposition = document.querySelector('svg#pie-chart').getBoundingClientRect().top;
      const pointerPosition = e.clientY;
      const tooltipYaxisPosition = pointerPosition - pieChartContainerYposition;

      tooltip.style.display = 'block';
      tooltip.style.top = ( tooltipYaxisPosition - 37.5 ) + 'px';
      tooltip.style.left = ( e.clientX + 7.5 )  + 'px';
      tooltip.querySelector('.equity').textContent = equity;
      tooltip.querySelector('.value').textContent = numberFormatterObject.format(value);
    });

    arc.addEventListener('pointerleave', () => {
      tooltip.style.display = 'none';
    });

    arc.addEventListener('touchstart', (e) => {
      e.preventDefault();
    });

    m++;
  })
}
//  treemap
function treemap(data) {
  // sort data by market cap
  data.sort( (a,b) => a.market_cap - b.market_cap ).reverse()
  const currencyOneDecimalPointsNumberFormatterObject = new Intl.NumberFormat('en-US', {style: 'currency', currency: 'USD', notation: "compact", compactDisplay: "short", maximumFractionDigits: 1});
  const thousandsSeparandNumberFormatterObject = new Intl.NumberFormat('en-GB');

  const leaves = Array.from(document.querySelectorAll('.treemap-leaves g')).slice(0,13);
  const tooltip =document.querySelector('.tooltip__treemap');

  leaves.forEach( (d,i) => {
    const name = data[i].short_name;
    const ticker = data[i].ticker;
    const marketCap = data[i].market_cap;
    const peRatio = data[i].pe_ratio;
    const tradeVolume30days = data[i].volume_30_day_avg;

    d.addEventListener('pointermove', (e) => {
      e.preventDefault();
      const pieChartContainerYposition = document.querySelector('svg#treemap').getBoundingClientRect().top;
      const pointerPosition = e.clientY;
      const tooltipYaxisPosition = pointerPosition - pieChartContainerYposition;

      tooltip.style.display = 'block';
      tooltip.style.top = ( tooltipYaxisPosition - 82.5 ) + 'px';
      tooltip.style.left = ( e.clientX + 7.5 )  + 'px';
      tooltip.querySelector('.name').textContent = `${name}  (${ticker})`;
      tooltip.querySelector('.market-cap').textContent = 'market cap: ' + currencyOneDecimalPointsNumberFormatterObject.format(marketCap);
      tooltip.querySelector('.pe-ratio').textContent = 'p/e-ratio: ' +  ( !peRatio ? '---' : `${peRatio}x` );
      tooltip.querySelector('.trade-volume-30-days').textContent = '30 day avg volume: ' + thousandsSeparandNumberFormatterObject.format(tradeVolume30days);
    })

    d.addEventListener('pointerleave', () => {
      tooltip.style.display = 'none';
    });

    d.addEventListener('touchstart', (e) => {
      e.preventDefault();
    });    
  })
}
